{% extends "base.html" %}
{% block title %}Activity Mode - FSL Practice Platform{% endblock %}
{% block content %}

<!-- Enhanced Header Section -->
<section class="section animate-fade-in-up">
  <div class="container text-center">
    <h1 style="font-size:3rem;font-weight:900;margin-bottom:1rem;color:var(--ink);">🎯 Activity Mode</h1>
    <p class="muted" style="font-size:1.25rem;max-width:80ch;margin:0 auto;">
      Practice Filipino Sign Language with AI-powered feedback and real-time evaluation
    </p>
  </div>
</section>

<section class="section">
  <div class="container">
    <!-- ACTIVITY PANEL -->
    <div class="card animate-fade-in-up">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
        <h2 style="margin:0;color:var(--secondary);font-size:1.5rem;">🎯 Practice & Evaluate</h2>
        <button class="btn animate-smooth-gradient" id="nextChallenge" style="background-size:200% 200%;">🎲 New Challenge</button>
      </div>
      <p class="muted" style="margin-bottom:2rem;">Practice signing the phrase shown below using your camera, then get AI-powered feedback and guidance.</p>

      <div class="card animate-subtle-pulse" style="background:linear-gradient(135deg, var(--accent), var(--accent-light));color:white;text-align:center;padding:2rem;">
        <div style="font-size:0.875rem;color:white;">Target Phrase:</div>
        <div style="font-size:1.5rem;font-weight:900;color:white;" id="targetPhrase">Loading...</div>
      </div>

      <div class="video-wrap animate-fade-in-up" style="margin-top:1.5rem;">
        <video id="cam" autoplay muted playsinline></video>
        <span class="badge">📹 Live Camera</span>
      </div>

      <!-- Activity Controls -->
      <div class="activity-controls animate-fade-in-up" style="margin-top:1.5rem;">
        <div style="display:flex;gap:0.75rem;margin-bottom:0.75rem;">
          <button id="startCam" class="btn" style="background:var(--primary);flex:1;">🎥 Start Camera</button>
          <button id="startRec" class="btn" style="background:var(--secondary);flex:1;">▶️ Start Recording</button>
        </div>
        <button id="stopRec" class="btn btn-large" style="background:var(--accent);width:100%;font-size:1.1rem;padding:1rem;">⏹️ Stop & Evaluate</button>
      </div>

      <details class="animate-fade-in-up" style="margin-top:1.5rem;">
        <summary class="muted" style="cursor:pointer;padding:0.75rem;background:var(--neutral-50);border-radius:var(--radius);">
          🤔 No camera? Try manual input (Demo Mode)
        </summary>
        <div class="grid grid-3 animate-fade-in-down" style="margin-top:1rem;gap:0.75rem;">
          <select id="attemptPick" style="padding:0.75rem;border-radius:var(--radius);border:2px solid var(--neutral-200);"></select>
          <input id="attemptManual" placeholder="Type your attempt..." style="padding:0.75rem;border-radius:var(--radius);border:2px solid var(--neutral-200);" />
          <button class="btn" id="assessManual" style="background:var(--neutral-700);">✨ Assess</button>
        </div>
      </details>
    </div>
  </div>
</section>

<!-- Enhanced Feedback Section -->
<section class="section animate-fade-in-up" id="feedbackSec">
  <div class="container">
    <div class="card">
      <div style="display:flex;align-items:center;gap:1rem;margin-bottom:2rem;">
        <div style="width:16px;height:16px;border-radius:50%;background:var(--accent);"></div>
        <h2 style="margin:0;color:var(--accent);font-size:1.75rem;">📊 Performance Feedback</h2>
      </div>

      <div id="feedbackBox" class="feedback animate-subtle-pulse" style="display:none;margin-bottom:2rem;"></div>

      <div id="reteach" class="animate-fade-in-up" style="display:none;">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;">
          <div style="width:12px;height:12px;border-radius:50%;background:var(--success);"></div>
          <h3 style="margin:0;color:var(--success);">🎓 Learn the Correct Sign</h3>
        </div>

        <div class="video-wrap animate-fade-in-left">
          <video id="reteachVideo" controls></video>
          <span class="badge success animate-pulse">✅ Correct Technique</span>
        </div>

        <div style="background:var(--success);background:linear-gradient(135deg, var(--success), var(--secondary-light));color:white;padding:1.5rem;border-radius:var(--radius-lg);margin-top:1.5rem;">
          <h4 style="margin-bottom:1rem;">📝 Correct Steps:</h4>
          <ol id="reteachSteps" style="margin:0;padding-left:1.5rem;"></ol>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Progress Section -->
<section class="section" style="background:var(--neutral-50);">
  <div class="container text-center">
    <h2 class="animate-fade-in-up" style="color:var(--primary);margin-bottom:2rem;">🚀 Ready for More?</h2>
    <div class="animate-fade-in-up animate-delay-1">
      <a class="btn" href="{{ url_for('home') }}" style="margin-right:1rem;background:var(--primary);">← Back to Home</a>
      <a class="btn btn-outline" href="{{ url_for('tutor') }}" style="background:var(--secondary);color:white;border-color:var(--secondary);">📚 Try Tutor Mode</a>
    </div>
  </div>
</section>

<script>
  const targetEl = document.getElementById("targetPhrase");
  const cam = document.getElementById("cam");
  const startCamBtn = document.getElementById("startCam");
  const startRecBtn = document.getElementById("startRec");
  const stopRecBtn = document.getElementById("stopRec");

  const attemptPick = document.getElementById("attemptPick");
  const attemptManual = document.getElementById("attemptManual");
  const assessManualBtn = document.getElementById("assessManual");

  const feedbackBox = document.getElementById("feedbackBox");
  const reteach = document.getElementById("reteach");
  const reteachVideo = document.getElementById("reteachVideo");
  const reteachSteps = document.getElementById("reteachSteps");

  let mediaStream = null;
  let frames = [];
  let target = "";

  // init
  fetch("/api/phrases").then(r=>r.json()).then(d=>{
    d.phrases.forEach(p=>{
      // attempt dropdown
      const opt = document.createElement("option");
      opt.value = p; opt.textContent = p;
      attemptPick.appendChild(opt);
    });
  });

  // random challenge
  document.getElementById("nextChallenge").onclick = async ()=>{
    const p = await fetch("/api/random").then(r=>r.json()).then(d=>d.phrase);
    target = p; targetEl.textContent = p;
  };
  // set an initial challenge
  document.getElementById("nextChallenge").click();

  // camera
  startCamBtn.onclick = async ()=>{
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      cam.srcObject = mediaStream;
    }catch(e){
      console.error('Camera error:', e);
      alert("Could not access camera: " + e.message);
    }
  };

  // record
  startRecBtn.onclick = ()=>{
    frames = [];
    if(!mediaStream){ alert("Start Camera first."); return; }
    const track = mediaStream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    let count = 0;
    const grab = async ()=>{
      try{
        const bmp = await imageCapture.grabFrame();
        const canvas = document.createElement("canvas");
        canvas.width = 320; canvas.height = 180;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(bmp, 0, 0, 320, 180);
        frames.push(canvas.toDataURL("image/jpeg", 0.6));
        count++;
        if(count < 8) setTimeout(grab, 200);
      }catch(e){ console.warn(e); }
    };
    grab();
  };

  // stop & evaluate
  stopRecBtn.onclick = async ()=>{
    const body = { target, frames };
    const res = await fetch("/api/assess", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) }).then(r=>r.json());
    showFeedback(res);
  };

  // manual assess
  assessManualBtn.onclick = async ()=>{
    const attempt = attemptManual.value.trim() || attemptPick.value;
    const res = await fetch("/api/assess", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ target, attempt_text: attempt }) }).then(r=>r.json());
    showFeedback(res);
  };

  function showFeedback(res){
    feedbackBox.style.display = "block";
    if(res.correct){
      feedbackBox.className = "feedback success";
      feedbackBox.innerHTML = `✅ <b>Correct!</b> Score: <span class="kpi">${(res.score*100).toFixed(0)}%</span>`;
      reteach.style.display = "none";
    }else{
      feedbackBox.className = "feedback danger";
      feedbackBox.innerHTML = `❌ <b>Incorrect.</b> Target: <b>${res.target}</b> — Score: <span class="kpi">${(res.score*100).toFixed(0)}%</span><br>${(res.hints||[]).join(" ")}`;
      // show teaching for the right sign
      reteach.style.display = "block";
      reteachVideo.src = (res.teach && res.teach.video) || "/static/video/sample.mp4";
      reteachVideo.load();
      reteachSteps.innerHTML = "";
      (res.teach && res.teach.steps || []).forEach(s=>{
        const li=document.createElement("li"); li.textContent = s; reteachSteps.appendChild(li);
      });
    }
    scrollToId("feedbackSec");
  }
</script>

{% endblock %}
