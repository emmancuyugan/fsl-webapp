{% extends "base.html" %}
{% block title %}Activity Mode - FSL Practice Platform{% endblock %}
{% block content %}

<!-- Enhanced Header Section -->
<section class="section animate-fade-in-up">
  <div class="container text-center">
    <h1 style="font-size:3rem;font-weight:900;margin-bottom:1rem;color:var(--ink);">ğŸ¯ Activity Mode</h1>
    <p class="muted" style="font-size:1.25rem;max-width:80ch;margin:0 auto;">
      Practice Filipino Sign Language with AI-powered feedback and real-time evaluation
    </p>
  </div>
</section>

<section class="section">
  <div class="container">
    <!-- ACTIVITY PANEL -->
    <div class="card animate-fade-in-up">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;">
        <h2 style="margin:0;color:var(--secondary);font-size:1.5rem;">ğŸ§© Activity and Evaluation</h2>
        <span class="pill success">Auto-Random Phrases</span>
      </div>
      <p class="muted" style="margin-bottom:2rem;">Activity: Perform the sign shown below using your camera, or upload a video if your camera isnâ€™t available. The system will then provide AI-powered feedback and guidance on your performance.</p>

      <div class="card" style="background:linear-gradient(135deg, var(--accent), var(--accent-light));color:white;text-align:center;padding:1.25rem;">
        <div style="font-size:0.75rem;color:white;">Target Phrase:</div>
        <div style="font-size:1.25rem;font-weight:900;color:white;" id="targetPhrase">Loading...</div>
      </div>

      <!-- Mode Selection -->
      <div style="margin-top:1.5rem;margin-bottom:1rem;">
        <div style="display:flex;gap:0.5rem;margin-bottom:1rem;">
          <button id="cameraMode" class="btn" style="background:var(--primary);flex:1;">ğŸ“¹ Camera Mode</button>
          <button id="uploadMode" class="btn btn-outline" style="flex:1;">ğŸ“ Upload Video</button>
        </div>
      </div>

      <!-- Camera Mode -->
      <div id="cameraSection" class="video-wrap animate-fade-in-up" style="margin-top:1.5rem;" onmouseover="this.style.transform='none'">
        <video id="cam" autoplay muted playsinline></video>
        <span class="badge">ğŸ“¹ Live Camera</span>
      </div>

      <!-- Upload Mode -->
      <div id="uploadSection" class="video-wrap animate-fade-in-up" style="margin-top:1.5rem;display:none;" onmouseover="this.style.transform='none'">
        <video id="uploadedVideo" controls></video>
        <span class="badge">ğŸ“ Uploaded Video</span>
        <div style="margin-top:1rem;">
          <input type="file" id="videoUpload" accept="video/*" style="margin-bottom:1rem;">
          <button id="processUpload" class="btn" style="background:var(--secondary);width:100%;">Process Uploaded Video</button>
        </div>
      </div>

      <!-- Activity Controls -->
      <div class="activity-controls animate-fade-in-up" style="margin-top:1.5rem;">
        <div style="display:flex;gap:0.75rem;margin-bottom:0.75rem;">
          <button id="startCam" class="btn" style="background:var(--primary);flex:1;">Start Camera</button>
          <button id="startRec" class="btn" style="background:var(--secondary);flex:1;">Start Recording</button>
        </div>
        <button id="stopRec" class="btn btn-large" style="background:var(--accent);width:100%;font-size:1.1rem;padding:1rem;">Stop & Evaluate</button>
      </div>


    </div>
  </div>
</section>

<!-- Enhanced Feedback Section -->
<section class="section animate-fade-in-up" id="feedbackSec">
  <div class="container">
    <div class="card">
      <div style="display:flex;align-items:center;gap:1rem;margin-bottom:2rem;">
        <div style="width:16px;height:16px;border-radius:50%;background:var(--accent);"></div>
        <h2 style="margin:0;color:var(--accent);font-size:1.75rem;">ğŸ“Š Performance Feedback</h2>
      </div>

      <div id="feedbackBox" class="feedback" style="display:none;margin-bottom:2rem;"></div>

      <div id="reteach" class="animate-fade-in-up" style="display:none;">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.5rem;">
          <div style="width:12px;height:12px;border-radius:50%;background:var(--success);"></div>
          <h3 style="margin:0;color:var(--success);">ğŸ“ Learn the Correct Sign</h3>
        </div>

        <div class="video-wrap animate-fade-in-left">
          <video id="reteachVideo" controls></video>
          <span class="badge success">âœ… Correct Technique</span>
        </div>

        <div style="background:var(--success);background:linear-gradient(135deg, var(--success), var(--secondary-light));color:white;padding:1.5rem;border-radius:var(--radius-lg);margin-top:1.5rem;">
          <h4 style="margin-bottom:1rem;">ğŸ“ Correct Steps:</h4>
          <ol id="reteachSteps" style="margin:0;padding-left:1.5rem;"></ol>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Progress Section -->
<section class="section" style="background:var(--neutral-50);">
  <div class="container text-center">
    <h2 class="animate-fade-in-up" style="color:var(--primary);margin-bottom:2rem;">Ready to Test Your Learnings?</h2>
    <div class="animate-fade-in-up animate-delay-1">
      <a class="btn" href="{{ url_for('home') }}" style="margin-right:1rem;background:var(--primary);"> <- Back</a>
      <a class="btn btn-outline" href="{{ url_for('results') }}" style="background:var(--accent);color:white;border-color:var(--accent);">View My Progress -></a>
    </div>
  </div>
</section>

<script>
  const targetEl = document.getElementById("targetPhrase");
  const cam = document.getElementById("cam");
  const startCamBtn = document.getElementById("startCam");
  const startRecBtn = document.getElementById("startRec");
  const stopRecBtn = document.getElementById("stopRec");

  const attemptPick = document.getElementById("attemptPick");
  const attemptManual = document.getElementById("attemptManual");
  const assessManualBtn = document.getElementById("assessManual");

  const feedbackBox = document.getElementById("feedbackBox");
  const reteach = document.getElementById("reteach");
  const reteachVideo = document.getElementById("reteachVideo");
  const reteachSteps = document.getElementById("reteachSteps");

  let mediaStream = null;
  let frames = [];
  let target = "";
  let currentMode = "camera"; // "camera" or "upload"
  let uploadedVideoFile = null;

  // init
  fetch("/api/phrases").then(r=>r.json()).then(d=>{
    d.phrases.forEach(p=>{
      // attempt dropdown
      const opt = document.createElement("option");
      opt.value = p; opt.textContent = p;
      attemptPick.appendChild(opt);
    });
  });

  // load random phrase
  async function loadRandomPhrase(){
    const p = await fetch("/api/random").then(r=>r.json()).then(d=>d.phrase);
    target = p; targetEl.textContent = p;
  }

  // set an initial challenge
  loadRandomPhrase();

  // auto-load new phrases every 45 seconds
  setInterval(loadRandomPhrase, 45000);

  // Mode switching functionality
  const cameraModeBtn = document.getElementById("cameraMode");
  const uploadModeBtn = document.getElementById("uploadMode");
  const cameraSection = document.getElementById("cameraSection");
  const uploadSection = document.getElementById("uploadSection");
  const videoUpload = document.getElementById("videoUpload");
  const processUploadBtn = document.getElementById("processUpload");

  // Mode switching
  cameraModeBtn.onclick = () => {
    currentMode = "camera";
    cameraSection.style.display = "block";
    uploadSection.style.display = "none";
    cameraModeBtn.className = "btn";
    cameraModeBtn.style.background = "var(--primary)";
    uploadModeBtn.className = "btn btn-outline";
    uploadModeBtn.style.background = "transparent";
  };

  uploadModeBtn.onclick = () => {
    currentMode = "upload";
    cameraSection.style.display = "none";
    uploadSection.style.display = "block";
    uploadModeBtn.className = "btn";
    uploadModeBtn.style.background = "var(--primary)";
    cameraModeBtn.className = "btn btn-outline";
    cameraModeBtn.style.background = "transparent";
  };

  // Video upload handling
  videoUpload.onchange = (e) => {
    const file = e.target.files[0];
    if (file) {
      uploadedVideoFile = file;
      const url = URL.createObjectURL(file);
      document.getElementById("uploadedVideo").src = url;
    }
  };

  // Process uploaded video
  processUploadBtn.onclick = () => {
    if (!uploadedVideoFile) {
      alert("Please select a video file first.");
      return;
    }
    extractFramesFromVideo(uploadedVideoFile);
  };

  // Extract frames from uploaded video
  function extractFramesFromVideo(file) {
    frames = [];
    const video = document.getElementById("uploadedVideo");
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 320;
    canvas.height = 180;

    video.currentTime = 0;

    const extractFrame = () => {
      if (video.currentTime < video.duration && frames.length < 8) {
        ctx.drawImage(video, 0, 0, 320, 180);
        frames.push(canvas.toDataURL("image/jpeg", 0.6));
        video.currentTime += 0.2; // Extract frame every 0.2 seconds
        setTimeout(extractFrame, 100);
      } else {
        alert(`Extracted ${frames.length} frames from video. Click "Stop & Evaluate" to get feedback.`);
      }
    };

    video.onloadedmetadata = () => {
      extractFrame();
    };
  }

  // camera
  startCamBtn.onclick = async ()=>{
    try{
      mediaStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
      cam.srcObject = mediaStream;
    }catch(e){
      console.error('Camera error:', e);
      alert("Could not access camera: " + e.message);
    }
  };

  // record
  startRecBtn.onclick = ()=>{
    frames = [];
    if(!mediaStream){ alert("Start Camera first."); return; }
    const track = mediaStream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    let count = 0;
    const grab = async ()=>{
      try{
        const bmp = await imageCapture.grabFrame();
        const canvas = document.createElement("canvas");
        canvas.width = 320; canvas.height = 180;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(bmp, 0, 0, 320, 180);
        frames.push(canvas.toDataURL("image/jpeg", 0.6));
        count++;
        if(count < 8) setTimeout(grab, 200);
      }catch(e){ console.warn(e); }
    };
    grab();
  };

  // stop & evaluate
  stopRecBtn.onclick = async ()=>{
    const body = { target, frames };
    const res = await fetch("/api/assess", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) }).then(r=>r.json());
    showFeedback(res);
  };

  // manual assess
  assessManualBtn.onclick = async ()=>{
    const attempt = attemptManual.value.trim() || attemptPick.value;
    const res = await fetch("/api/assess", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ target, attempt_text: attempt }) }).then(r=>r.json());
    showFeedback(res);
  };

  function showFeedback(res){
    feedbackBox.style.display = "block";

    // Record session data for results page
    recordSessionData(target, res);

    if(res.correct){
      feedbackBox.className = "feedback success";
      feedbackBox.innerHTML = `âœ… <b>Correct!</b>`;
      reteach.style.display = "none";
    }else{
      feedbackBox.className = "feedback danger";
      feedbackBox.innerHTML = `âŒ <b>Incorrect.</b> Target: <b>${res.target}</b><br>${(res.hints||[]).join(" ")}`;
      // show teaching for the right sign
      reteach.style.display = "block";
      reteachVideo.src = (res.teach && res.teach.video) || "/static/video/sample.mp4";
      reteachVideo.load();
      reteachSteps.innerHTML = "";
      (res.teach && res.teach.steps || []).forEach(s=>{
        const li=document.createElement("li"); li.textContent = s; reteachSteps.appendChild(li);
      });
    }
    scrollToId("feedbackSec");
  }

  // Record session data for results tracking
  function recordSessionData(targetPhrase, result) {
    const sessionData = {
      date: new Date().toISOString(),
      phrase: targetPhrase,
      correct: result.correct,
      confidence: result.confidence || 0,
      mode: currentMode,
      timestamp: Date.now()
    };

    // Get existing sessions from localStorage
    const existingSessions = JSON.parse(localStorage.getItem('fslPracticeSessions') || '[]');

    // Add new session
    existingSessions.unshift(sessionData);

    // Keep only last 50 sessions
    if (existingSessions.length > 50) {
      existingSessions.splice(50);
    }

    // Save back to localStorage
    localStorage.setItem('fslPracticeSessions', JSON.stringify(existingSessions));

    console.log('Session recorded:', sessionData);
  }
</script>

{% endblock %}
